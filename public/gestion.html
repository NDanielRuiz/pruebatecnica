<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Proyectos</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <h1 class="text-4xl font-bold text-center text-blue-600 mb-8">
            📋 Gestión de Proyectos
        </h1>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 id="form-title" class="text-2xl mb-4">Añadir un Nuevo Proyecto</h2>
            <form id="project-form" class="space-y-4">
                <div>
                    <label for="name" class="block font-medium">Nombre del Proyecto:</label>
                    <input type="text" id="name" name="name" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="description" class="block font-medium">Descripción:</label>
                    <input type="text" id="description" name="description" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300">
                    Guardar Proyecto
                </button>
            </form>
        </div>

        <h2 class="text-3xl font-bold mb-4">Proyectos Existentes</h2>
        <div id="projects-list" class="space-y-4"></div>
        
        <div id="single-project-view" class="hidden"></div>
    </div>

<script>
    // --- 1. REFERENCIAS A ELEMENTOS DEL HTML ---
    const projectsListDiv = document.getElementById('projects-list');
    const projectForm = document.getElementById('project-form');
    const formTitle = document.getElementById('form-title');
    const formButton = document.querySelector('#project-form button');
    const singleProjectView = document.getElementById('single-project-view');
    const mainViewContainer = document.querySelector('#project-form').parentElement.parentElement;

    // Variable para saber si estamos editando un proyecto
    let currentlyEditingId = null;

    // --- 2. FUNCIÓN PARA CARGAR Y MOSTRAR PROYECTOS (GET) ---
    const loadProjects = async () => {
        try {
            const response = await fetch('/projects', { cache: 'no-cache' });
            const projects = await response.json();
            projectsListDiv.innerHTML = '';
            if (projects.length === 0) {
                projectsListDiv.innerHTML = '<p class="text-gray-500">No hay proyectos creados todavía.</p>';
                return;
            }
            projects.forEach(project => {
                const projectId = project.pk.split('#')[1];
                const projectCard = document.createElement('div');
                projectCard.className = 'bg-white p-4 rounded-lg shadow-md mb-4 flex justify-between items-center project-card cursor-pointer';
                projectCard.dataset.projectId = projectId;
                projectCard.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${project.Name}</h3>
                        <p class="text-gray-600">${project.Description}</p>
                    </div>
                    <div class="space-x-2">
                        <button data-id="${projectId}" class="edit-btn bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded">Editar</button>
                        <button data-id="${projectId}" class="delete-btn bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">Eliminar</button>
                    </div>
                `;
                projectsListDiv.appendChild(projectCard);
            });
        } catch (error) {
            console.error('Error al cargar los proyectos:', error);
        }
    };

    // --- 3. FUNCIÓN PARA RESETEAR EL FORMULARIO DE PROYECTOS ---
    const resetForm = () => {
        projectForm.reset();
        currentlyEditingId = null;
        formTitle.textContent = 'Añadir un Nuevo Proyecto';
        formButton.textContent = 'Guardar Proyecto';
        if (formButton.classList.contains('bg-green-500')) {
            formButton.classList.replace('bg-green-500', 'bg-blue-500');
            formButton.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
        }
    };

    // --- 4. FUNCIÓN PARA MOSTRAR LA VISTA DE TAREAS ---
    const showTasksForProject = async (projectId) => {
        try {
            // Hacemos las dos peticiones a la vez para más eficiencia
            const [projectResponse, tasksResponse] = await Promise.all([
                fetch(`/projects/${projectId}`, { cache: 'no-cache' }),
                fetch(`/projects/${projectId}/tasks`, { cache: 'no-cache' })
            ]);
            const project = await projectResponse.json();
            const tasks = await tasksResponse.json();

            // Ocultamos la vista principal y mostramos la de tareas
            mainViewContainer.classList.add('hidden');
            singleProjectView.classList.remove('hidden');

            // Creamos el HTML para cada tarea
            let tasksHTML = '';
            tasks.forEach(task => {
                const taskId = task.sk.split('#')[1];
                tasksHTML += `
                    <div class="bg-gray-50 p-3 rounded-md shadow-sm flex justify-between items-center">
                        <div>
                            <h4 class="font-bold">${task.Title}</h4>
                            <p class="text-sm text-gray-600">${task.Description}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-white bg-blue-500 px-2 py-1 rounded-full">${task.Status}</span>
                            <button data-project-id="${projectId}" data-task-id="${taskId}" class="delete-task-btn bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-xs">X</button>
                        </div>
                    </div>
                `;
            });

            // Llenamos el contenedor de la vista de tareas con todo el HTML
            singleProjectView.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button id="back-to-projects" class="mb-4 text-blue-600 hover:underline">&larr; Volver a todos los proyectos</button>
                    <h2 class="text-3xl font-bold">${project.Name}</h2>
                    <p class="text-gray-500 mb-6">${project.Description}</p>
                    
                    <div class="bg-gray-100 p-4 rounded-lg mb-6">
                        <h3 class="text-xl font-bold mb-3">Añadir Nueva Tarea</h3>
                        <form id="task-form" data-project-id="${projectId}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="title" placeholder="Título de la tarea" required class="p-2 border rounded w-full">
                                <input type="text" name="description" placeholder="Descripción" required class="p-2 border rounded w-full">
                                <select name="priority" class="p-2 border rounded w-full">
                                    <option value="baja">Baja Prioridad</option><option value="media" selected>Media Prioridad</option><option value="alta">Alta Prioridad</option><option value="urgente">Urgente</option>
                                </select>
                                <select name="status" class="p-2 border rounded w-full">
                                    <option value="pendiente" selected>Pendiente</option><option value="en progreso">En Progreso</option><option value="completada">Completada</option><option value="bloqueada">Bloqueada</option>
                                </select>
                            </div>
                            <button type="submit" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Añadir Tarea</button>
                        </form>
                    </div>

                    <h3 class="text-2xl font-bold mb-4">Tareas del Proyecto</h3>
                    <div class="space-y-3">
                        ${tasks.length > 0 ? tasksHTML : '<p class="text-gray-500">Este proyecto no tiene tareas todavía.</p>'}
                    </div>
                </div>
            `;
        } catch (error) {
            console.error("Error al mostrar las tareas del proyecto:", error);
        }
    };

    // --- 5. LÓGICA DE EVENTOS (LISTENERS) ---

    // Listener para el formulario de PROYECTOS (Crear o Actualizar)
    projectForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const name = event.target.name.value;
        const description = event.target.description.value;
        const projectData = { name, description };
        try {
            const url = currentlyEditingId ? `/projects/${currentlyEditingId}` : '/projects';
            const method = currentlyEditingId ? 'PUT' : 'POST';
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(projectData) });
            resetForm();
            loadProjects();
        } catch (error) { console.error('Error al guardar el proyecto:', error); }
    });

    // Listener para los clics en la lista de PROYECTOS (Editar, Eliminar o Ver Tareas)
    projectsListDiv.addEventListener('click', async (event) => {
        const target = event.target;
        if (target.classList.contains('delete-btn')) {
            const projectId = target.dataset.id;
            if (confirm('¿Estás seguro?')) {
                try {
                    await fetch(`/projects/${projectId}`, { method: 'DELETE' });
                    loadProjects();
                } catch (error) { console.error('Error al eliminar el proyecto:', error); }
            }
        } else if (target.classList.contains('edit-btn')) {
            const projectId = target.dataset.id;
            try {
                const response = await fetch(`/projects/${projectId}`, { cache: 'no-cache' });
                const project = await response.json();
                projectForm.name.value = project.Name;
                projectForm.description.value = project.Description;
                currentlyEditingId = projectId;
                formTitle.textContent = 'Editar Proyecto';
                formButton.textContent = 'Actualizar Proyecto';
                formButton.classList.replace('bg-blue-500', 'bg-green-500');
                formButton.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) { console.error('Error al obtener datos para editar:', error); }
        } else {
            const projectCard = target.closest('.project-card');
            if (projectCard) {
                const projectId = projectCard.dataset.projectId;
                showTasksForProject(projectId);
            }
        }
    });

    // Listener para los eventos que ocurren DENTRO de la vista de TAREAS
    singleProjectView.addEventListener('submit', async (event) => {
        if (event.target.id === 'task-form') {
            event.preventDefault();
            const projectId = event.target.dataset.projectId;
            const taskData = {
                title: event.target.title.value,
                description: event.target.description.value,
                priority: event.target.priority.value,
                status: event.target.status.value,
            };
            try {
                await fetch(`/projects/${projectId}/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData),
                });
                showTasksForProject(projectId);
            } catch (error) { console.error('Error al crear la tarea:', error); }
        }
    });

    singleProjectView.addEventListener('click', async (event) => {
        if (event.target.classList.contains('delete-task-btn')) {
            const projectId = event.target.dataset.projectId;
            const taskId = event.target.dataset.taskId;
            if (confirm('¿Eliminar esta tarea?')) {
                try {
                    await fetch(`/projects/${projectId}/tasks/${taskId}`, { method: 'DELETE' });
                    showTasksForProject(projectId);
                } catch (error) { console.error('Error al eliminar la tarea:', error); }
            }
        }
    });

    // Listener para el botón de "Volver"
    document.body.addEventListener('click', (event) => {
        if (event.target.id === 'back-to-projects') {
            mainViewContainer.classList.remove('hidden');
            singleProjectView.classList.add('hidden');
        }
    });

    // --- 6. CARGA INICIAL ---
    document.addEventListener('DOMContentLoaded', loadProjects);
</script>
</body>
</html>